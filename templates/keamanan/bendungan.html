{% extends 'layouts/master.html' %}

{% set title = "Keamanan" %}

{% block css %}
<style media="screen">
    a[aria-expanded=true] .fa-chevron-down {
       display: none;
    }
    a[aria-expanded=false] .fa-chevron-up {
       display: none;
    }
</style>
<link href="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet"/>
{% endblock %}

{% block content %}
    <div style="height: 85px;"></div>
    <section class="content-header">
        <h2>{{ waduk.nama }}</h2>
    </section>
    <hr>
    <div class="row">
        <div class="col-md-6">
            <section class="content-header">
                <h4>
                    <b>VNotch</b>
                    <a class="ml-5"
                        data-toggle="collapse" href="#form-add-vnotch"
                        role="button" aria-expanded="false"
                        aria-controls="">
                        <i class="fas fa-plus mr-2"></i>
                    </a>
                </h4>
            </section>
            <div class="row collapse" id="form-add-vnotch">
                <form method="POST" action="{{ path_for('keamanan.vnotch.add', {'id': waduk.id}, {'sampling': sampling}) }}">
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label class="form-text" for="sampling">Tanggal</label>
                            <div class="input-group">
                                <span class="input-group-addon" id="calendar_addon"><i class="fas fa-calendar mr-2 text-right"></i></span>
                                <input class="form-control" type="text" name="sampling" id="sampling" required value="{{ sampling | date('Y-m-d') }}" aria-describedby="calendar_addon">
                            </div>
                        </div>
                    </div>
                    <br>
                    {% for v in vnotch %}
                        <h3>{{ v.nama }}</h3>
                        <div class="row">
                            <div class="form-group col-md-6">
                                <label for="tma-{{ v.id }}">Tinggi Muka Air</label>
                                <div class="input-group">
                                    <input id="tma-{{ v.id }}" name="tma-{{ v.id }}" autofocus required class="form-control" type="number" step="0.01" value="" aria-describedby="tma_addon">
                                    <span class="input-group-addon" id="tma_addon">m</span>
                                </div>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="debit-{{ v.id }}">Debit Air</label>
                                <div class="input-group">
                                    <input id="debit-{{ v.id }}" name="debit-{{ v.id }}" autofocus required class="form-control" type="number" step="0.01" value="" aria-describedby="debit_addon">
                                    <span class="input-group-addon" id="debit_addon">m<sup>3</sup></span>
                                </div>
                            </div>
                        </div>
                        <hr>
                    {% endfor %}
                  <div class="form-group">
                    <input type="submit" class="btn btn-primary" value="Tambah">
                  </div>
                </form>
            </div>
        </div>
        <div class="col-md-6">
            <section class="content-header">
                <h4>
                    <b>Piezometer</b>
                    <a class="ml-5"
                        data-toggle="collapse" href="#form-add-piezometer"
                        role="button" aria-expanded="false"
                        aria-controls="">
                        <i class="fas fa-plus mr-2"></i>
                    </a>
                </h4>
            </section>
            <div class="row collapse" id="form-add-piezometer">
                <form method="POST" action="{{ path_for('keamanan.piezometer.add', {'id': waduk.id}, {'sampling': sampling}) }}">
                    <div class="row">
                        <div class="form-group col-md-6">
                            <label class="form-text" for="sampling">Tanggal</label>
                            <div class="input-group">
                                <span class="input-group-addon" id="calendar_addon"><i class="fas fa-calendar mr-2 text-right"></i></span>
                                <input class="form-control" type="text" name="sampling" id="sampling2" required value="{{ sampling | date('Y-m-d') }}" aria-describedby="calendar_addon">
                            </div>
                        </div>
                    </div>
                    <br>
                    {% for p in piezometer %}
                        <h3>{{ p.nama }}</h3>
                        <div class="row">
                            <div class="form-group col-md-8">
                                <label for="tma-{{ p.id }}">Tinggi Muka Air</label>
                                <div class="input-group">
                                    <input id="tma-{{ p.id }}" name="tma-{{ p.id }}" autofocus required class="form-control" type="number" step="0.01" value="" aria-describedby="tma_addon">
                                    <span class="input-group-addon" id="tma_addon">m</span>
                                </div>
                            </div>
                        </div>
                        <hr>
                    {% endfor %}
                  <div class="form-group">
                    <input type="submit" class="btn btn-primary" value="Tambah">
                  </div>
                </form>
            </div>
        </div>
    </div>
    <h3>
        Data Keamanan
        <span id="datepicker" style="color: #18bc9c"> {{ sampling | date('M Y') }}</span>
    </h3>
    <hr>
    <table class="table table-bordered table-stripped">
        <thead>
            <tr class="active">
              <th rowspan="2">Tanggal</th>
              <th colspan="3">VNotch</th>
              <th colspan="{{ piezometer | length }}">Piezometer</th>
            </tr>
            <tr class="active">
              <th>Nama</th>
              <th>Tinggi</th>
              <th>Debit</th>
              {% for p in piezometer %}
                <th>{{ p.nama }}</th>
              {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for t, per in periodik %}
                {% for v in vnotch %}
                    <tr>
                        {% if loop.index == 1 %}
                            <td rowspan="{{ vnotch | length }}">{{ t | date('d M Y') }}</td>
                        {% endif %}
                        <td>{{ v.nama }}</td>
                        <td align="right">
                            <a data-url="/keamanan/{{ waduk.id }}/vnotch/update" class="editable" data-name="tma_{{ t }}_{{ v.id }}" data-type="number" data-step="any" data-step="any" data-pk="{{ per.vnotch[v.nama].id }}">
                                {% if per.vnotch[v.nama].tma %}{{ per.vnotch[v.nama].tma }}{% else %}<span style="color: red;">Empty</span>{% endif %}
                            </a>
                        </td>
                        <td align="right">
                            <a data-url="/keamanan/{{ waduk.id }}/vnotch/update" class="editable" data-name="debit_{{ t }}_{{ v.id }}" data-type="number" data-step="any" data-step="any" data-pk="{{ per.vnotch[v.nama].id }}">
                                {% if per.vnotch[v.nama].debit %}{{ per.vnotch[v.nama].debit }}{% else %}<span style="color: red;">Empty</span>{% endif %}
                            </a>
                        </td>
                        {% if loop.index == 1 %}
                            {% for p in piezometer %}
                                <td rowspan="{{ vnotch | length }}" align="right">
                                    <a data-url="/keamanan/{{ waduk.id }}/piezometer/update" class="editable" data-name="tma_{{ t }}_{{ p.id }}" data-type="number" data-step="any" data-step="any" data-pk="{{ per.piezometer[p.nama].id }}">
                                        {% if per.piezometer[p.nama].tma %}{{ per.piezometer[p.nama].tma }}{% else %}<span style="color: red;">Empty</span>{% endif %}
                                    </a>
                                </td>
                            {% endfor %}
                        {% endif %}
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    {% for t, per in periodik %}
        <h6>
            <b>{{ t }}</b>
            <span>|</span>
            <span style="color: {% if per.vnotch %}blue{% else %}red{% endif %};">VNotch</span>
            <span>|</span>
            <span style="color: {% if per.piezometer %}blue{% else %}red{% endif %};">Piezometer</span>
            <a class="ml-3"
                data-toggle="collapse" href="#periodik-{{ per.id }}"
                role="button" aria-expanded="false"
                aria-controls="">
                <i class="fa fa-chevron-up pull-right"></i>
                <i class="fa fa-chevron-down pull-right"></i>
            </a>
        </h6>
        <div class="row collapse" id="periodik-{{ per.id }}">
            <div class="col-md-6">
                <h5>VNotch</h5>
                <div class="ml-3">
                    {% if per.vnotch %}
                        {% for v in per.vnotch %}
                            <p><b>{{ v.nama }}</b></p>
                            <div class="row ml-3">
                                <div class="col-md-6">
                                    <p>TMA : {{ v.tma }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p>Debit : {{ v.debit }}</p>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: red;"><b>Belum Ada Data</b></p>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <h5>Piezometer</h5>
                <div class="ml-3">
                    {% if per.piezometer %}
                        {% for p in per.piezometer %}
                            <p><b>{{ p.nama }}</b></p>
                            <div class="ml-3">
                            <p>TMA : {{ p.tma }}</p>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p style="color: red;"><b>Belum Ada Data</b></p>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}

{% block js %}
    <script src="//cdnjs.cloudflare.com/ajax/libs/x-editable/1.5.0/bootstrap3-editable/js/bootstrap-editable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js" type="text/javascript"></script>
    <script>
        // resolve package confict
        let datepicker = $.fn.datepicker.noConflict();
        $.fn.bootstrapDP = datepicker;

        $('#datepicker').datepicker({
            todayHighlight: true,
            autoclose: true,
            format: 'yyyy-mm-dd'
        });
        $('#datepicker').on('changeDate', function () {
            window.location = "{{ path_for('keamanan.bendungan', {'id': waduk.id}) }}?sampling=" + $('#datepicker').datepicker('getFormattedDate')
        });

        $('#sampling').datepicker({
            todayHighlight: true,
            autoclose: true,
            format: 'yyyy-mm-dd'
        });

        $('#sampling2').datepicker({
            todayHighlight: true,
            autoclose: true,
            format: 'yyyy-mm-dd'
        });

        //turn to popup mode
        $.fn.editable.defaults.mode = 'popup';
        $(document).ready(function() {
            $('.editable').editable();
        });
    </script>
{% endblock %}
